import React, { useMemo, useRef, useState } from "react";
// If these libs aren't auto-available in preview, the export button will hide gracefully.
// In a real project, add: npm i html-to-image file-saver
import { toPng } from "html-to-image";


export default function VehicleAdBuilder() {
// --- STATE ---
const [aspect, setAspect] = useState("1:1"); // "1:1" | "16:9"
const [photoUrl, setPhotoUrl] = useState<string | null>(null);
const [zoom, setZoom] = useState(100); // %
const [offsetX, setOffsetX] = useState(50); // 0-100 background-position
const [offsetY, setOffsetY] = useState(50);


const [primaryHex, setPrimaryHex] = useState("#f77f00"); // H1, CTA, Price
const [secondaryHex, setSecondaryHex] = useState("#ff9730"); // lighter orange
const [textHex, setTextHex] = useState("#ffffff");
const [infoOpacity, setInfoOpacity] = useState(65); // % for black info bar


// Vehicle fields (prefilled from user's message)
const [headline, setHeadline] = useState("2019 KIA STINGER GT2");
const [price, setPrice] = useState("$27,500");
const [miles, setMiles] = useState("68,231");
const [engine, setEngine] = useState("V6, Twin Turbo, 3.3 Liter");
const [drivetrain, setDrivetrain] = useState("RWD");
const [mpg, setMpg] = useState("City 19 / Hwy 25");
const [stock, setStock] = useState("K63742");
const [vin, setVin] = useState("KNAE55LC6K6063742");
const [body, setBody] = useState("GT2 Sedan 4D");
const [lot, setLot] = useState("Athens Lot");
const [address, setAddress] = useState("4 Green Street, Athens, TN 37303");
const [phone, setPhone] = useState("(423) 435-2177");


const [hook, setHook] = useState(
"Forget boring gifts! This Christmas, get behind the wheel of a true sport sedan."
);
const [blurb, setBlurb] = useState(
"This 2019 Kia Stinger GT2 delivers thrilling performance thanks to its 3.3L Twin Turbo V6 and luxurious features. It's the ultimate upgrade for your holiday commute."
);
const [hashtags, setHashtags] = useState(
"#KiaStinger #StingerGT2 #TwinTurbo #SportSedan #ChristmasDeals #KiaForSale #LuxuryCar #RWD #athenstn"
);


const [footerBadges, setFooterBadges] = useState(
"Trades welcome • Financing with approved credit • No Doc Fees"
);


const previewRef = useRef<HTMLDivElement | null>(null);


const px = useMemo(() => (aspect === "1:1" ? { w: 1080, h: 1080 } : { w: 1920, h: 1080 }), [aspect]);


const infoBg = useMemo(() => `rgba(0,0,0,${Math.round(infoOpacity) / 100})`, [infoOpacity]);


const canExport = typeof toPng === "function";


// --- HANDLERS ---
const onPhoto = (e: React.ChangeEvent<HTMLInputElement>) => {
const f = e.target.files?.[0];
if (!f) return;
const url = URL.createObjectURL(f);
setPhotoUrl(url);
};


const exportPng = async () => {
if (!previewRef.current || !canExport) return;
try {
const node = previewRef.current;
const dataUrl = await toPng(node, { cacheBust: true, pixelRatio: 1 });
const link = document.createElement("a");
link.download = `${headline.replace(/\s+/g, "_")}_${aspect.replace(":", "-")}.png`;
link.href = dataUrl;
link.click();
} catch (e) {
console.error(e);
}